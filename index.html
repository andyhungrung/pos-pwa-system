<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
    <meta name="theme-color" content="#2563eb" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <link rel="manifest" href="manifest.json" />
    <title>POSÈä∑ÂîÆÁ≥ªÁµ±</title>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: #f3f4f6; }
        .container { height: 100vh; display: flex; flex-direction: column; }
        .header { background: white; padding: 16px; border-bottom: 1px solid #e5e7eb; }
        .title { font-size: 24px; font-weight: bold; color: #1f2937; text-align: center; }
        .main { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        
        /* ÊâãÊ©üÊ®£Âºè */
        @media (max-width: 768px) {
            .products-area { flex: 2; padding: 16px; overflow-y: auto; }
            .cart-area { flex: 1; background: white; border-top: 2px solid #e5e7eb; padding: 16px; min-height: 200px; max-height: 350px; display: flex; flex-direction: column; }
        }
        
        /* Ê°åÈù¢Ê®£Âºè */
        @media (min-width: 769px) {
            .main { flex-direction: row; }
            .products-area { flex: 1; padding: 24px; }
            .cart-area { width: 320px; background: white; border-left: 1px solid #e5e7eb; padding: 24px; display: flex; flex-direction: column; }
        }
        
        .section-title { font-size: 20px; font-weight: 600; margin-bottom: 16px; }
        .manual-input { background: white; padding: 16px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 16px; }
        .input-group { display: flex; gap: 8px; flex-direction: column; }
        @media (min-width: 769px) { .input-group { flex-direction: row; } }
        
        .input { padding: 16px 12px; border: 2px solid #d1d5db; border-radius: 8px; font-size: 16px; }
        .input:focus { outline: none; border-color: #3b82f6; }
        .button { padding: 16px; background: #16a34a; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 16px; }
        .button:hover { background: #15803d; }
        .button:disabled { opacity: 0.5; cursor: not-allowed; }
        .button-blue { background: #2563eb; }
        .button-blue:hover { background: #1d4ed8; }
        
        .product-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
        @media (min-width: 769px) { .product-grid { grid-template-columns: repeat(3, 1fr); } }
        @media (min-width: 1024px) { .product-grid { grid-template-columns: repeat(4, 1fr); } }
        
        .product-card { background: white; padding: 16px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border: 2px solid transparent; cursor: pointer; text-align: center; min-height: 90px; display: flex; flex-direction: column; justify-content: center; }
        .product-card:hover { box-shadow: 0 4px 6px rgba(0,0,0,0.1); border-color: #60a5fa; }
        .product-name { font-weight: 500; margin-bottom: 4px; }
        .product-price { color: #2563eb; font-weight: bold; }
        
        .cart-items { flex: 1; overflow-y: auto; margin-bottom: 12px; }
        .cart-item { display: flex; justify-content: between; align-items: center; padding: 8px 0; border-bottom: 1px solid #f3f4f6; }
        .cart-item-info { flex: 1; min-width: 0; }
        .cart-item-name { font-weight: 500; font-size: 14px; }
        .cart-item-detail { font-size: 12px; color: #6b7280; }
        .cart-controls { display: flex; gap: 4px; align-items: center; }
        .control-btn { width: 32px; height: 32px; background: #e5e7eb; border: none; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .control-btn:hover { background: #d1d5db; }
        .quantity { width: 32px; text-align: center; font-size: 14px; }
        
        .cart-total { padding-top: 12px; border-top: 1px solid #e5e7eb; }
        .total-text { font-size: 18px; font-weight: bold; margin-bottom: 12px; }
        
        .modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; padding: 16px; }
        .modal-content { background: white; padding: 24px; border-radius: 8px; width: 100%; max-width: 400px; }
        .modal-title { font-size: 18px; font-weight: 600; margin-bottom: 8px; }
        .modal-text { color: #6b7280; margin-bottom: 16px; }
        .hidden { display: none; }
        
        .empty-cart { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: #6b7280; text-align: center; }
    </style>
</head>
<body>
    <div id="app" class="container">
        <div class="header">
            <h1 class="title">POSÈä∑ÂîÆÁ≥ªÁµ±</h1>
        </div>

        <div class="main">
            <div class="products-area">
                <h2 class="section-title">ÂïÜÂìÅÈÅ∏Êìá</h2>
                
                <div class="manual-input">
                    <h3 style="font-weight: 500; margin-bottom: 12px;">Âø´ÈÄüÊñ∞Â¢ûÂïÜÂìÅ</h3>
                    <div class="input-group">
                        <input id="productName" type="text" class="input" placeholder="ÂïÜÂìÅÂêçÁ®±" style="flex: 1;">
                        <input id="productPrice" type="number" class="input" placeholder="ÂÉπÊ†º" step="0.01" style="width: 120px;">
                        <button id="addManualBtn" class="button">Êñ∞Â¢û</button>
                    </div>
                </div>
                
                <div id="productGrid" class="product-grid">
                    <!-- ÂïÜÂìÅÂ∞áÂú®ÈÄôË£°ÂãïÊÖãÂä†Ëºâ -->
                </div>
            </div>

            <div class="cart-area">
                <h2 class="section-title">Ë≥ºÁâ©Ëªä</h2>
                
                <div id="cartItems" class="cart-items">
                    <div class="empty-cart">
                        <div style="font-size: 32px; margin-bottom: 8px;">üõí</div>
                        <p>Ë≥ºÁâ©ËªäÊòØÁ©∫ÁöÑ</p>
                    </div>
                </div>
                
                <div class="cart-total">
                    <div id="totalAmount" class="total-text">Á∏ΩË®à: $0</div>
                    <button id="checkoutBtn" class="button button-blue" style="width: 100%;" disabled>ÁµêÂ∏≥</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ÊèêÁ§∫Â∞çË©±Ê°Ü -->
    <div id="alertModal" class="modal hidden">
        <div class="modal-content">
            <h3 class="modal-title">ÊèêÁ§∫Ë®äÊÅØ</h3>
            <p id="alertMessage" class="modal-text"></p>
            <button id="alertOkBtn" class="button button-blue" style="width: 100%;">Á¢∫ÂÆö</button>
        </div>
    </div>

    <script>
        // ÂÖ®Â±ÄËÆäÊï∏
        let products = [];
        let cart = [];
        let cartTotal = 0;

        // IndexedDB Áõ∏Èóú
        const DB_NAME = 'POSSystemDB';
        const DB_VERSION = 1;
        const PRODUCTS_STORE = 'products';

        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onerror = () => reject(request.error);
                request.onsuccess = () => resolve(request.result);
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains(PRODUCTS_STORE)) {
                        db.createObjectStore(PRODUCTS_STORE, { keyPath: 'id' });
                    }
                };
            });
        }

        async function dbOperation(storeName, operation, data = null) {
            try {
                const db = await initDB();
                const transaction = db.transaction([storeName], operation === 'getAll' ? 'readonly' : 'readwrite');
                const store = transaction.objectStore(storeName);
                let request;
                
                switch (operation) {
                    case 'add': request = store.add(data); break;
                    case 'put': request = store.put(data); break;
                    case 'getAll': request = store.getAll(); break;
                }
                
                return new Promise((resolve, reject) => {
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            } catch (error) {
                console.error('DBÊìç‰ΩúÂ§±Êïó:', error);
                return null;
            }
        }

        // È°ØÁ§∫ÊèêÁ§∫
        function showAlert(message) {
            document.getElementById('alertMessage').textContent = message;
            document.getElementById('alertModal').classList.remove('hidden');
        }

        // ËºâÂÖ•ÂïÜÂìÅ
        async function loadProducts() {
            const allProducts = await dbOperation(PRODUCTS_STORE, 'getAll');
            products = allProducts || [];
            renderProducts();
        }

        // Ê∏≤ÊüìÂïÜÂìÅÁ∂≤Ê†º
        function renderProducts() {
            const grid = document.getElementById('productGrid');
            grid.innerHTML = '';
            
            products.forEach(product => {
                const card = document.createElement('div');
                card.className = 'product-card';
                card.innerHTML = `
                    <div class="product-name">${product.name}</div>
                    <div class="product-price">$${product.price}</div>
                `;
                card.onclick = () => addToCart(product);
                grid.appendChild(card);
            });
        }

        // Ê∑ªÂä†Âà∞Ë≥ºÁâ©Ëªä
        function addToCart(product) {
            const existingItem = cart.find(item => item.id === product.id);
            if (existingItem) {
                existingItem.quantity += 1;
            } else {
                cart.push({ ...product, quantity: 1 });
            }
            updateCart();
        }

        // Êõ¥Êñ∞Ë≥ºÁâ©ËªäÈ°ØÁ§∫
        function updateCart() {
            const cartItemsDiv = document.getElementById('cartItems');
            const totalDiv = document.getElementById('totalAmount');
            const checkoutBtn = document.getElementById('checkoutBtn');
            
            if (cart.length === 0) {
                cartItemsDiv.innerHTML = `
                    <div class="empty-cart">
                        <div style="font-size: 32px; margin-bottom: 8px;">üõí</div>
                        <p>Ë≥ºÁâ©ËªäÊòØÁ©∫ÁöÑ</p>
                    </div>
                `;
                checkoutBtn.disabled = true;
                cartTotal = 0;
            } else {
                cartItemsDiv.innerHTML = '';
                cartTotal = 0;
                
                cart.forEach(item => {
                    cartTotal += item.price * item.quantity;
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'cart-item';
                    itemDiv.innerHTML = `
                        <div class="cart-item-info">
                            <div class="cart-item-name">${item.name}</div>
                            <div class="cart-item-detail">$${item.price} √ó ${item.quantity}</div>
                        </div>
                        <div class="cart-controls">
                            <button class="control-btn" onclick="updateQuantity('${item.id}', ${item.quantity - 1})">-</button>
                            <span class="quantity">${item.quantity}</span>
                            <button class="control-btn" onclick="updateQuantity('${item.id}', ${item.quantity + 1})">+</button>
                            <button class="control-btn" onclick="removeFromCart('${item.id}')" style="background: #fef2f2; color: #dc2626;">√ó</button>
                        </div>
                    `;
                    cartItemsDiv.appendChild(itemDiv);
                });
                checkoutBtn.disabled = false;
            }
            
            totalDiv.textContent = `Á∏ΩË®à: $${cartTotal}`;
        }

        // Êõ¥Êñ∞ÂïÜÂìÅÊï∏Èáè
        function updateQuantity(productId, newQuantity) {
            if (newQuantity <= 0) {
                removeFromCart(productId);
            } else {
                const item = cart.find(item => item.id === productId);
                if (item) {
                    item.quantity = newQuantity;
                    updateCart();
                }
            }
        }

        // ÂæûË≥ºÁâ©ËªäÁßªÈô§
        function removeFromCart(productId) {
            cart = cart.filter(item => item.id !== productId);
            updateCart();
        }

        // ÁµêÂ∏≥
        function checkout() {
            if (cart.length === 0) return;
            showAlert(`ÁµêÂ∏≥ÊàêÂäüÔºÅÁ∏ΩÈáëÈ°çÔºö$${cartTotal}`);
            cart = [];
            updateCart();
        }

        // Ê∑ªÂä†ÊâãÂãïÂïÜÂìÅ
        async function addManualProduct() {
            const nameInput = document.getElementById('productName');
            const priceInput = document.getElementById('productPrice');
            const name = nameInput.value.trim();
            const price = parseFloat(priceInput.value);
            
            if (!name || !price) {
                showAlert('Ë´ãËº∏ÂÖ•ÂïÜÂìÅÂêçÁ®±ÂíåÂÉπÊ†º');
                return;
            }
            
            const product = {
                id: 'manual_' + Date.now(),
                name: name,
                price: price
            };
            
            // ‰øùÂ≠òÂà∞Ë≥áÊñôÂ∫´
            await dbOperation(PRODUCTS_STORE, 'put', product);
            
            // Ê∑ªÂä†Âà∞Ë≥ºÁâ©Ëªä
            addToCart(product);
            
            // Ê∏ÖÁ©∫Ëº∏ÂÖ•Ê°Ü
            nameInput.value = '';
            priceInput.value = '';
            
            // ÈáçÊñ∞ËºâÂÖ•ÂïÜÂìÅ
            await loadProducts();
        }

        // ÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', async function() {
            // ËºâÂÖ•ÂïÜÂìÅ
            await loadProducts();
            
            // Á∂ÅÂÆö‰∫ã‰ª∂
            document.getElementById('addManualBtn').onclick = addManualProduct;
            document.getElementById('checkoutBtn').onclick = checkout;
            document.getElementById('alertOkBtn').onclick = () => {
                document.getElementById('alertModal').classList.add('hidden');
            };
            
            console.log('POSÁ≥ªÁµ±ÂàùÂßãÂåñÂÆåÊàê');
        });
    </script>
</body>
</html>
