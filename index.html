<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
    <meta name="theme-color" content="#2563eb" />
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="manifest" href="manifest.json" />
    <title>POSÈä∑ÂîÆÁ≥ªÁµ±</title>
    
    <!-- Chart.js CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: #f3f4f6; }
        .container { height: 100vh; display: flex; flex-direction: column; }
        
        .header { background: white; padding: 16px; border-bottom: 1px solid #e5e7eb; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .nav { display: flex; justify-content: space-between; align-items: center; }
        .title { font-size: 24px; font-weight: bold; color: #1f2937; }
        .nav-buttons { display: flex; gap: 8px; }
        .nav-btn { padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.2s; }
        .nav-btn.active { background: #2563eb; color: white; }
        .nav-btn:not(.active) { background: #e5e7eb; color: #374151; }
        .nav-btn:hover:not(.active) { background: #d1d5db; }
        
        .main { flex: 1; overflow: hidden; }
        .page { display: none; height: 100%; }
        .page.active { display: flex; flex-direction: column; }
        
        .page-content { flex: 1; padding: 16px; overflow-y: auto; }
        .section-title { font-size: 20px; font-weight: 600; margin-bottom: 16px; }
        .card { background: white; padding: 16px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 16px; }
        .input { padding: 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; width: 100%; }
        .input:focus { outline: none; border-color: #3b82f6; }
        .button { padding: 12px 16px; background: #2563eb; color: white; border: none; border-radius: 6px; font-weight: 500; cursor: pointer; }
        .button:hover { background: #1d4ed8; }
        .button:disabled { opacity: 0.5; cursor: not-allowed; }
        .button-green { background: #16a34a; }
        .button-green:hover { background: #15803d; }
        .button-red { background: #dc2626; }
        .button-red:hover { background: #b91c1c; }
        .button-gray { background: #6b7280; }
        .button-gray:hover { background: #4b5563; }
        
        .sales-layout { flex: 1; display: flex; flex-direction: column; }
        @media (min-width: 769px) { .sales-layout { flex-direction: row; } }
        
        .products-area { flex: 2; padding: 16px; overflow-y: auto; }
        .cart-area { flex: 1; background: white; border-top: 2px solid #e5e7eb; padding: 16px; min-height: 200px; display: flex; flex-direction: column; }
        @media (min-width: 769px) { 
            .cart-area { width: 320px; border-top: none; border-left: 1px solid #e5e7eb; }
        }
        
        .manual-input { background: white; padding: 16px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 16px; }
        .input-group { display: flex; gap: 8px; flex-direction: column; }
        @media (min-width: 769px) { .input-group { flex-direction: row; } }
        
        .product-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
        @media (min-width: 769px) { .product-grid { grid-template-columns: repeat(3, 1fr); } }
        @media (min-width: 1024px) { .product-grid { grid-template-columns: repeat(4, 1fr); } }
        
        .product-card { background: white; padding: 16px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); cursor: pointer; text-align: center; min-height: 80px; display: flex; flex-direction: column; justify-content: center; border: 2px solid transparent; }
        .product-card:hover { border-color: #60a5fa; }
        
        .cart-items { flex: 1; overflow-y: auto; margin-bottom: 12px; }
        .cart-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #f3f4f6; }
        .cart-controls { display: flex; gap: 4px; align-items: center; }
        .control-btn { width: 28px; height: 28px; background: #e5e7eb; border: none; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 14px; }
        
        .table { width: 100%; border-collapse: collapse; }
        .table th, .table td { padding: 12px; text-align: left; border-bottom: 1px solid #e5e7eb; }
        .table th { background: #f9fafb; font-weight: 600; }
        
        .modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; padding: 16px; }
        .modal-content { background: white; padding: 24px; border-radius: 8px; width: 100%; max-width: 400px; }
        .hidden { display: none; }
        
        .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-bottom: 24px; }
        @media (min-width: 769px) { .stats-grid { grid-template-columns: repeat(4, 1fr); } }
        .stat-card { background: white; padding: 20px; border-radius: 8px; text-align: center; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .stat-number { font-size: 24px; font-weight: bold; color: #2563eb; }
        .stat-label { font-size: 12px; color: #6b7280; margin-top: 4px; }
        
        .charts-container { display: grid; grid-template-columns: 1fr; gap: 24px; margin-bottom: 24px; }
        @media (min-width: 1024px) { .charts-container { grid-template-columns: 1fr 1fr; } }
        
        .chart-card { background: white; padding: 24px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); transition: all 0.3s ease; }
        .chart-card:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0,0,0,0.15); }
        
        .chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .chart-title { font-size: 18px; font-weight: 700; color: #1f2937; }
        .chart-subtitle { font-size: 14px; color: #6b7280; margin-top: 4px; }
        
        .chart-wrapper { position: relative; height: 300px; margin-bottom: 20px; }
        
        .chart-legend { display: grid; grid-template-columns: 1fr; gap: 8px; max-height: 200px; overflow-y: auto; }
        .legend-item { display: flex; align-items: center; justify-content: space-between; padding: 8px 12px; background: #f9fafb; border-radius: 6px; font-size: 14px; }
        .legend-color { width: 16px; height: 16px; border-radius: 4px; margin-right: 8px; }
        .legend-info { display: flex; align-items: center; flex: 1; }
        .legend-value { font-weight: 600; color: #374151; }
        .legend-percentage { font-size: 12px; color: #6b7280; margin-left: 4px; }
        
        .empty-state { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 200px; color: #9ca3af; }
        .empty-state-icon { font-size: 48px; margin-bottom: 12px; }
        .empty-state-text { font-size: 16px; font-weight: 500; }
        .empty-state-subtext { font-size: 14px; margin-top: 4px; }
        
        @media (max-width: 768px) {
            .chart-wrapper { height: 250px; }
            .charts-container { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div id="app" class="container">
        <div class="header">
            <div class="nav">
                <h1 class="title">POSÈä∑ÂîÆÁ≥ªÁµ±</h1>
                <div class="nav-buttons">
                    <button class="nav-btn active" onclick="APP.showPage('sales')">Èä∑ÂîÆ</button>
                    <button class="nav-btn" onclick="APP.showPage('products')">ÂïÜÂìÅ</button>
                    <button class="nav-btn" onclick="APP.showPage('reports')">Â†±Ë°®</button>
                    <button class="nav-btn" onclick="APP.showPage('backup')">ÂÇô‰ªΩ</button>
                </div>
            </div>
        </div>

        <div class="main">
            <div id="salesPage" class="page active">
                <div class="sales-layout">
                    <div class="products-area">
                        <h2 class="section-title">ÂïÜÂìÅÈÅ∏Êìá</h2>
                        
                        <div class="manual-input">
                            <h3 style="font-weight: 500; margin-bottom: 12px;">Âø´ÈÄüÊñ∞Â¢ûÂïÜÂìÅ</h3>
                            <div class="input-group">
                                <input id="productName" type="text" class="input" placeholder="ÂïÜÂìÅÂêçÁ®±" style="flex: 1;">
                                <input id="productPrice" type="number" class="input" placeholder="ÂÉπÊ†º" step="0.01" style="width: 120px;">
                                <button onclick="APP.addManualProduct()" class="button button-green">Êñ∞Â¢û</button>
                            </div>
                        </div>
                        
                        <div id="productGrid" class="product-grid"></div>
                    </div>

                    <div class="cart-area">
                        <h2 class="section-title">Ë≥ºÁâ©Ëªä</h2>
                        <div id="cartItems" class="cart-items">
                            <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: #6b7280;">
                                <div style="font-size: 32px; margin-bottom: 8px;">üõí</div>
                                <p>Ë≥ºÁâ©ËªäÊòØÁ©∫ÁöÑ</p>
                            </div>
                        </div>
                        <div style="padding-top: 12px; border-top: 1px solid #e5e7eb;">
                            <div id="totalAmount" style="font-size: 18px; font-weight: bold; margin-bottom: 12px;">Á∏ΩË®à: $0</div>
                            <button onclick="APP.checkout()" class="button" style="width: 100%;" id="checkoutBtn" disabled>ÁµêÂ∏≥</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="productsPage" class="page">
                <div class="page-content">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                        <h2 class="section-title" style="margin: 0;">ÂïÜÂìÅÁÆ°ÁêÜ</h2>
                        <button class="button button-green" onclick="APP.showProductModal()">Êñ∞Â¢ûÂïÜÂìÅ</button>
                    </div>
                    
                    <div class="card">
                        <table class="table" id="productsTable">
                            <thead>
                                <tr>
                                    <th>ÂïÜÂìÅÂêçÁ®±</th>
                                    <th>ÂÉπÊ†º</th>
                                    <th>Êìç‰Ωú</th>
                                </tr>
                            </thead>
                            <tbody id="productsTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="reportsPage" class="page">
                <div class="page-content">
                    <h2 class="section-title">Èä∑ÂîÆÂ†±Ë°®</h2>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div id="totalProducts" class="stat-number">0</div>
                            <div class="stat-label">ÂïÜÂìÅÁ∏ΩÊï∏</div>
                        </div>
                        <div class="stat-card">
                            <div id="totalSales" class="stat-number">0</div>
                            <div class="stat-label">Èä∑ÂîÆÁ≠ÜÊï∏</div>
                        </div>
                        <div class="stat-card">
                            <div id="totalRevenue" class="stat-number">$0</div>
                            <div class="stat-label">Á∏ΩÁáüÊî∂</div>
                        </div>
                        <div class="stat-card">
                            <div id="avgOrder" class="stat-number">$0</div>
                            <div class="stat-label">Âπ≥ÂùáÂÆ¢ÂñÆÂÉπ</div>
                        </div>
                    </div>

                    <div class="charts-container">
                        <div class="chart-card">
                            <div class="chart-header">
                                <div>
                                    <div class="chart-title">üìä ÂïÜÂìÅÈä∑ÂîÆÊï∏ÈáèÂàÜÊûê</div>
                                    <div class="chart-subtitle">‰æùÈä∑ÂîÆÊï∏ÈáèÁµ±Ë®àÂêÑÂïÜÂìÅÂç†ÊØî</div>
                                </div>
                            </div>
                            <div class="chart-wrapper">
                                <canvas id="quantityChart"></canvas>
                                <div id="quantityEmptyState" class="empty-state hidden">
                                    <div class="empty-state-icon">üìà</div>
                                    <div class="empty-state-text">Êö´ÁÑ°Èä∑ÂîÆÊï∏Êìö</div>
                                    <div class="empty-state-subtext">ÂÆåÊàêÈ¶ñÁ≠ÜÈä∑ÂîÆÂæåÂç≥ÂèØÊü•ÁúãÂàÜÊûê</div>
                                </div>
                            </div>
                            <div id="quantityLegend" class="chart-legend"></div>
                        </div>

                        <div class="chart-card">
                            <div class="chart-header">
                                <div>
                                    <div class="chart-title">üí∞ ÂïÜÂìÅÈä∑ÂîÆÈáëÈ°çÂàÜÊûê</div>
                                    <div class="chart-subtitle">‰æùÈä∑ÂîÆÈáëÈ°çÁµ±Ë®àÂêÑÂïÜÂìÅÂç†ÊØî</div>
                                </div>
                            </div>
                            <div class="chart-wrapper">
                                <canvas id="revenueChart"></canvas>
                                <div id="revenueEmptyState" class="empty-state hidden">
                                    <div class="empty-state-icon">üí∏</div>
                                    <div class="empty-state-text">Êö´ÁÑ°ÁáüÊî∂Êï∏Êìö</div>
                                    <div class="empty-state-subtext">ÂÆåÊàêÈ¶ñÁ≠ÜÈä∑ÂîÆÂæåÂç≥ÂèØÊü•ÁúãÂàÜÊûê</div>
                                </div>
                            </div>
                            <div id="revenueLegend" class="chart-legend"></div>
                        </div>
                    </div>

                    <div class="card">
                        <h3 style="font-weight: 600; margin-bottom: 16px;">Èä∑ÂîÆË®òÈåÑ</h3>
                        <div id="salesHistory" style="max-height: 300px; overflow-y: auto;">
                            <p style="text-align: center; color: #6b7280; padding: 40px;">Êö´ÁÑ°Èä∑ÂîÆË®òÈåÑ</p>
                        </div>
                    </div>
                </div>
            </div>

            <div id="backupPage" class="page">
                <div class="page-content">
                    <h2 class="section-title">Ë≥áÊñôÂÇô‰ªΩËàáÈÇÑÂéü</h2>
                    
                    <div style="display: grid; grid-template-columns: 1fr; gap: 16px;">
                        <div class="card">
                            <h3 style="font-weight: 600; margin-bottom: 12px;">ÂÇô‰ªΩË≥áÊñô</h3>
                            <p style="color: #6b7280; margin-bottom: 16px;">Â∞áÊâÄÊúâÂïÜÂìÅÂíåÈä∑ÂîÆË≥áÊñôÂåØÂá∫ÁÇ∫Ê™îÊ°à</p>
                            <button class="button" onclick="APP.exportData()">ÂåØÂá∫Ë≥áÊñô</button>
                        </div>
                        
                        <div class="card">
                            <h3 style="font-weight: 600; margin-bottom: 12px;">ÈÇÑÂéüË≥áÊñô</h3>
                            <p style="color: #6b7280; margin-bottom: 16px;">ÂæûÂÇô‰ªΩÊ™îÊ°àÈÇÑÂéüË≥áÊñô</p>
                            <input type="file" id="importFile" accept=".json" style="margin-bottom: 12px;">
                            <button class="button button-gray" onclick="APP.importData()">ÂåØÂÖ•Ë≥áÊñô</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="productModal" class="modal hidden">
        <div class="modal-content">
            <h3 id="modalTitle" style="font-size: 18px; font-weight: 600; margin-bottom: 16px;">Êñ∞Â¢ûÂïÜÂìÅ</h3>
            <div style="margin-bottom: 16px;">
                <label style="display: block; margin-bottom: 4px; font-weight: 500;">ÂïÜÂìÅÂêçÁ®±</label>
                <input id="modalProductName" type="text" class="input">
            </div>
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 4px; font-weight: 500;">ÂÉπÊ†º</label>
                <input id="modalProductPrice" type="number" class="input" step="0.01">
            </div>
            <div style="display: flex; gap: 8px;">
                <button class="button" onclick="APP.saveProduct()">ÂÑ≤Â≠ò</button>
                <button class="button button-gray" onclick="APP.closeProductModal()">ÂèñÊ∂à</button>
            </div>
        </div>
    </div>

    <div id="alertModal" class="modal hidden">
        <div class="modal-content">
            <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 8px;">ÊèêÁ§∫Ë®äÊÅØ</h3>
            <p id="alertMessage" style="color: #6b7280; margin-bottom: 16px;"></p>
            <button class="button" onclick="APP.closeAlert()">Á¢∫ÂÆö</button>
        </div>
    </div>

    <script>
        const APP = (function() {
            let products = [];
            let cart = [];
            let cartTotal = 0;
            let sales = [];
            let editingProductId = null;
            let quantityChart = null;
            let revenueChart = null;

            const chartColors = [
                '#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', 
                '#FFEAA7', '#DDA0DD', '#98D8C8', '#F7DC6F',
                '#AED6F1', '#A9DFBF', '#F8C471', '#D7BDE2'
            ];

            const DB_NAME = 'POSSystemDB';
            const DB_VERSION = 2;
            const PRODUCTS_STORE = 'products';
            const SALES_STORE = 'sales';

            function initDB() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(DB_NAME, DB_VERSION);
                    request.onerror = () => reject(request.error);
                    request.onsuccess = () => resolve(request.result);
                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        if (!db.objectStoreNames.contains(PRODUCTS_STORE)) {
                            db.createObjectStore(PRODUCTS_STORE, { keyPath: 'id' });
                        }
                        if (!db.objectStoreNames.contains(SALES_STORE)) {
                            db.createObjectStore(SALES_STORE, { keyPath: 'id' });
                        }
                    };
                });
            }

            async function dbOperation(storeName, operation, data = null) {
                try {
                    const db = await initDB();
                    const transaction = db.transaction([storeName], operation === 'getAll' ? 'readonly' : 'readwrite');
                    const store = transaction.objectStore(storeName);
                    let request;
                    
                    switch (operation) {
                        case 'add': request = store.add(data); break;
                        case 'put': request = store.put(data); break;
                        case 'delete': request = store.delete(data); break;
                        case 'getAll': request = store.getAll(); break;
                    }
                    
                    return new Promise((resolve, reject) => {
                        request.onsuccess = () => resolve(request.result);
                        request.onerror = () => reject(request.error);
                    });
                } catch (error) {
                    console.error('DBÊìç‰ΩúÂ§±Êïó:', error);
                    return null;
                }
            }

            function showPage(pageName) {
                console.log('ÂàáÊèõÂà∞:', pageName);
                
                document.querySelectorAll('.page').forEach(page => {
                    page.classList.remove('active');
                });
                
                document.querySelectorAll('.nav-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                const targetPage = document.getElementById(pageName + 'Page');
                if (targetPage) {
                    targetPage.classList.add('active');
                }
                
                const clickedBtn = event ? event.target : null;
                if (clickedBtn) {
                    clickedBtn.classList.add('active');
                } else {
                    document.querySelectorAll('.nav-btn').forEach(btn => {
                        if (btn.textContent.includes(pageName === 'sales' ? 'Èä∑ÂîÆ' : pageName === 'products' ? 'ÂïÜÂìÅ' : pageName === 'reports' ? 'Â†±Ë°®' : 'ÂÇô‰ªΩ')) {
                            btn.classList.add('active');
                        }
                    });
                }
                
                switch(pageName) {
                    case 'products':
                        renderProductsTable();
                        break;
                    case 'reports':
                        updateReports();
                        setTimeout(() => updateCharts(), 100);
                        break;
                }
            }

            function showAlert(message) {
                document.getElementById('alertMessage').textContent = message;
                document.getElementById('alertModal').classList.remove('hidden');
            }

            function closeAlert() {
                document.getElementById('alertModal').classList.add('hidden');
            }

            async function loadProducts() {
                const allProducts = await dbOperation(PRODUCTS_STORE, 'getAll');
                products = allProducts || [];
                renderProducts();
            }

            async function loadSales() {
                const allSales = await dbOperation(SALES_STORE, 'getAll');
                sales = allSales || [];
            }

            function renderProducts() {
                const grid = document.getElementById('productGrid');
                grid.innerHTML = '';
                
                products.forEach(product => {
                    const card = document.createElement('div');
                    card.className = 'product-card';
                    card.innerHTML = `
                        <div style="font-weight: 500; margin-bottom: 4px;">${product.name}</div>
                        <div style="color: #2563eb; font-weight: bold;">$${product.price}</div>
                    `;
                    card.onclick = () => addToCart(product);
                    grid.appendChild(card);
                });
            }

            function renderProductsTable() {
                const tbody = document.getElementById('productsTableBody');
                tbody.innerHTML = '';
                
                if (products.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; color: #6b7280; padding: 40px;">Êö´ÁÑ°ÂïÜÂìÅË≥áÊñô</td></tr>';
                    return;
                }
                
                products.forEach(product => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${product.name}</td>
                        <td>$${product.price}</td>
                        <td>
                            <button class="button" onclick="APP.editProduct('${product.id}')" style="padding: 6px 12px; font-size: 12px; margin-right: 8px;">Á∑®ËºØ</button>
                            <button class="button button-red" onclick="APP.deleteProduct('${product.id}')" style="padding: 6px 12px; font-size: 12px;">Âà™Èô§</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            }

            function addToCart(product) {
                const existingItem = cart.find(item => item.id === product.id);
                if (existingItem) {
                    existingItem.quantity += 1;
                } else {
                    cart.push({ ...product, quantity: 1 });
                }
                updateCart();
            }

            function updateCart() {
                const cartItemsDiv = document.getElementById('cartItems');
                const totalDiv = document.getElementById('totalAmount');
                const checkoutBtn = document.getElementById('checkoutBtn');
                
                if (cart.length === 0) {
                    cartItemsDiv.innerHTML = `
                        <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: #6b7280;">
                            <div style="font-size: 32px; margin-bottom: 8px;">üõí</div>
                            <p>Ë≥ºÁâ©ËªäÊòØÁ©∫ÁöÑ</p>
                        </div>
                    `;
                    checkoutBtn.disabled = true;
                    cartTotal = 0;
                } else {
                    cartItemsDiv.innerHTML = '';
                    cartTotal = 0;
                    
                    cart.forEach(item => {
                        cartTotal += item.price * item.quantity;
                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'cart-item';
                        itemDiv.innerHTML = `
                            <div style="flex: 1;">
                                <div style="font-weight: 500; font-size: 14px;">${item.name}</div>
                                <div style="font-size: 12px; color: #6b7280;">$${item.price} √ó ${item.quantity}</div>
                            </div>
                            <div class="cart-controls">
                                <button class="control-btn" onclick="APP.updateQuantity('${item.id}', ${item.quantity - 1})">-</button>
                                <span style="width: 32px; text-align: center; font-size: 14px;">${item.quantity}</span>
                                <button class="control-btn" onclick="APP.updateQuantity('${item.id}', ${item.quantity + 1})">+</button>
                                <button class="control-btn" onclick="APP.removeFromCart('${item.id}')" style="background: #fef2f2; color: #dc2626;">√ó</button>
                            </div>
                        `;
                        cartItemsDiv.appendChild(itemDiv);
                    });
                    checkoutBtn.disabled = false;
                }
                
                totalDiv.textContent = `Á∏ΩË®à: $${cartTotal}`;
            }

            function updateQuantity(productId, newQuantity) {
                if (newQuantity <= 0) {
                    removeFromCart(productId);
                } else {
                    const item = cart.find(item => item.id === productId);
                    if (item) {
                        item.quantity = newQuantity;
                        updateCart();
                    }
                }
            }

            function removeFromCart(productId) {
                cart = cart.filter(item => item.id !== productId);
                updateCart();
            }

            async function checkout() {
                if (cart.length === 0) return;
                
                const sale = {
                    id: Date.now().toString(),
                    items: [...cart],
                    total: cartTotal,
                    timestamp: new Date().toISOString()
                };
                
                await dbOperation(SALES_STORE, 'add', sale);
                sales.push(sale);
                
                showAlert(`ÁµêÂ∏≥ÊàêÂäüÔºÅÁ∏ΩÈáëÈ°çÔºö${cartTotal}`);
                cart = [];
                updateCart();
            }

            function showProductModal(product = null) {
                editingProductId = product ? product.id : null;
                document.getElementById('modalTitle').textContent = product ? 'Á∑®ËºØÂïÜÂìÅ' : 'Êñ∞Â¢ûÂïÜÂìÅ';
                document.getElementById('modalProductName').value = product ? product.name : '';
                document.getElementById('modalProductPrice').value = product ? product.price : '';
                document.getElementById('productModal').classList.remove('hidden');
            }

            function closeProductModal() {
                document.getElementById('productModal').classList.add('hidden');
                editingProductId = null;
            }

            async function saveProduct() {
                const name = document.getElementById('modalProductName').value.trim();
                const price = parseFloat(document.getElementById('modalProductPrice').value);
                
                if (!name || !price) {
                    showAlert('Ë´ãËº∏ÂÖ•ÂïÜÂìÅÂêçÁ®±ÂíåÂÉπÊ†º');
                    return;
                }
                
                const product = {
                    id: editingProductId || Date.now().toString(),
                    name: name,
                    price: price
                };
                
                await dbOperation(PRODUCTS_STORE, 'put', product);
                
                if (editingProductId) {
                    const index = products.findIndex(p => p.id === editingProductId);
                    if (index !== -1) {
                        products[index] = product;
                    }
                } else {
                    products.push(product);
                }
                
                renderProducts();
                renderProductsTable();
                closeProductModal();
                showAlert(editingProductId ? 'ÂïÜÂìÅÊõ¥Êñ∞ÊàêÂäü' : 'ÂïÜÂìÅÊñ∞Â¢ûÊàêÂäü');
            }

            function editProduct(id) {
                const product = products.find(p => p.id === id);
                if (product) {
                    showProductModal(product);
                }
            }

            async function deleteProduct(id) {
                if (!confirm('Á¢∫ÂÆöË¶ÅÂà™Èô§Ê≠§ÂïÜÂìÅÂóéÔºü')) return;
                
                await dbOperation(PRODUCTS_STORE, 'delete', id);
                products = products.filter(p => p.id !== id);
                renderProducts();
                renderProductsTable();
                showAlert('ÂïÜÂìÅÂà™Èô§ÊàêÂäü');
            }

            async function addManualProduct() {
                console.log('Âø´ÈÄüÊñ∞Â¢ûÂïÜÂìÅ');
                const name = document.getElementById('productName').value.trim();
                const price = parseFloat(document.getElementById('productPrice').value);
                
                if (!name || !price) {
                    showAlert('Ë´ãËº∏ÂÖ•ÂïÜÂìÅÂêçÁ®±ÂíåÂÉπÊ†º');
                    return;
                }
                
                const product = {
                    id: Date.now().toString(),
                    name: name,
                    price: price
                };
                
                await dbOperation(PRODUCTS_STORE, 'put', product);
                products.push(product);
                addToCart(product);
                
                document.getElementById('productName').value = '';
                document.getElementById('productPrice').value = '';
                
                renderProducts();
            }

            function createPieChart(canvasId, data, labels, colors) {
                const ctx = document.getElementById(canvasId).getContext('2d');
                
                return new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: colors,
                            borderColor: '#ffffff',
                            borderWidth: 2,
                            hoverBorderWidth: 3
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                titleColor: 'white',
                                bodyColor: 'white',
                                borderColor: '#2563eb',
                                borderWidth: 1,
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label;
                                        const value = context.formattedValue;
                                        const percentage = ((context.parsed / context.dataset.data.reduce((a, b) => a + b)) * 100).toFixed(1);
                                        return `${label}: ${value} (${percentage}%)`;
                                    }
                                }
                            }
                        },
                        animation: {
                            animateRotate: true,
                            duration: 1500
                        }
                    }
                });
            }

            function updateChartLegend(legendId, data, labels, colors, isRevenue = false) {
                const legend = document.getElementById(legendId);
                const total = data.reduce((sum, value) => sum + value, 0);
                
                legend.innerHTML = '';
                
                data.forEach((value, index) => {
                    const percentage = ((value / total) * 100).toFixed(1);
                    const legendItem = document.createElement('div');
                    legendItem.className = 'legend-item';
                    legendItem.innerHTML = `
                        <div class="legend-info">
                            <div class="legend-color" style="background-color: ${colors[index]}"></div>
                            <span>${labels[index]}</span>
                        </div>
                        <div>
                            <span class="legend-value">${isRevenue ? ' + value.toLocaleString() : value.toLocaleString()}</span>
                            <span class="legend-percentage">(${percentage}%)</span>
                        </div>
                    `;
                    legend.appendChild(legendItem);
                });
            }

            function updateCharts() {
                console.log('Êõ¥Êñ∞ÂúìÈ§ÖÂúñ');
                
                if (quantityChart) {
                    quantityChart.destroy();
                    quantityChart = null;
                }
                if (revenueChart) {
                    revenueChart.destroy();
                    revenueChart = null;
                }
                
                const productStats = {};
                
                sales.forEach(sale => {
                    sale.items.forEach(item => {
                        if (!productStats[item.name]) {
                            productStats[item.name] = {
                                quantity: 0,
                                revenue: 0
                            };
                        }
                        productStats[item.name].quantity += item.quantity;
                        productStats[item.name].revenue += item.quantity * item.price;
                    });
                });
                
                const productNames = Object.keys(productStats);
                
                if (productNames.length === 0) {
                    document.getElementById('quantityEmptyState').classList.remove('hidden');
                    document.getElementById('revenueEmptyState').classList.remove('hidden');
                    document.getElementById('quantityChart').style.display = 'none';
                    document.getElementById('revenueChart').style.display = 'none';
                    document.getElementById('quantityLegend').innerHTML = '';
                    document.getElementById('revenueLegend').innerHTML = '';
                    return;
                }
                
                document.getElementById('quantityEmptyState').classList.add('hidden');
                document.getElementById('revenueEmptyState').classList.add('hidden');
                document.getElementById('quantityChart').style.display = 'block';
                document.getElementById('revenueChart').style.display = 'block';
                
                const quantities = productNames.map(name => productStats[name].quantity);
                const revenues = productNames.map(name => productStats[name].revenue);
                const colors = productNames.map((_, index) => chartColors[index % chartColors.length]);
                
                const quantitySorted = productNames
                    .map((name, index) => ({ name, quantity: quantities[index], color: colors[index] }))
                    .sort((a, b) => b.quantity - a.quantity);
                
                const revenueSorted = productNames
                    .map((name, index) => ({ name, revenue: revenues[index], color: colors[index] }))
                    .sort((a, b) => b.revenue - a.revenue);
                
                quantityChart = createPieChart(
                    'quantityChart',
                    quantitySorted.map(item => item.quantity),
                    quantitySorted.map(item => item.name),
                    quantitySorted.map(item => item.color)
                );
                
                revenueChart = createPieChart(
                    'revenueChart',
                    revenueSorted.map(item => item.revenue),
                    revenueSorted.map(item => item.name),
                    revenueSorted.map(item => item.color)
                );
                
                updateChartLegend(
                    'quantityLegend',
                    quantitySorted.map(item => item.quantity),
                    quantitySorted.map(item => item.name),
                    quantitySorted.map(item => item.color)
                );
                
                updateChartLegend(
                    'revenueLegend',
                    revenueSorted.map(item => item.revenue),
                    revenueSorted.map(item => item.name),
                    revenueSorted.map(item => item.color),
                    true
                );
            }

            function updateReports() {
                const totalProductsEl = document.getElementById('totalProducts');
                const totalSalesEl = document.getElementById('totalSales');
                const totalRevenueEl = document.getElementById('totalRevenue');
                const avgOrderEl = document.getElementById('avgOrder');
                const salesHistoryEl = document.getElementById('salesHistory');
                
                totalProductsEl.textContent = products.length;
                totalSalesEl.textContent = sales.length;
                
                const revenue = sales.reduce((sum, sale) => sum + sale.total, 0);
                totalRevenueEl.textContent = `${revenue.toLocaleString()}`;
                avgOrderEl.textContent = sales.length > 0 ? `${Math.round(revenue / sales.length)}` : '$0';
                
                if (sales.length === 0) {
                    salesHistoryEl.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 40px;">Êö´ÁÑ°Èä∑ÂîÆË®òÈåÑ</p>';
                } else {
                    salesHistoryEl.innerHTML = '';
                    sales.slice(-10).reverse().forEach(sale => {
                        const saleDiv = document.createElement('div');
                        saleDiv.style.cssText = 'padding: 12px; border-bottom: 1px solid #f3f4f6;';
                        saleDiv.innerHTML = `
                            <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                                <span style="font-size: 12px; color: #6b7280;">${new Date(sale.timestamp).toLocaleString('zh-TW')}</span>
                                <span style="font-weight: 600;">${sale.total}</span>
                            </div>
                            <div style="font-size: 12px; color: #6b7280;">
                                ${sale.items.map(item => `${item.name}√ó${item.quantity}`).join(', ')}
                            </div>
                        `;
                        salesHistoryEl.appendChild(saleDiv);
                    });
                }
            }

            function exportData() {
                const data = {
                    products: products,
                    sales: sales,
                    timestamp: new Date().toISOString()
                };
                
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `POSÂÇô‰ªΩ_${new Date().toLocaleDateString('zh-TW').replace(/\//g, '-')}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showAlert('Ë≥áÊñôÂåØÂá∫ÊàêÂäüÔºÅ');
            }

            function importData() {
                const fileInput = document.getElementById('importFile');
                const file = fileInput.files[0];
                
                if (!file) {
                    showAlert('Ë´ãÈÅ∏ÊìáË¶ÅÂåØÂÖ•ÁöÑÊ™îÊ°à');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        
                        if (!confirm('ÂåØÂÖ•Ë≥áÊñôÂ∞áË¶ÜËìãÁèæÊúâË≥áÊñôÔºåÁ¢∫ÂÆöË¶ÅÁπºÁ∫åÂóéÔºü')) return;
                        
                        if (data.products) {
                            for (const product of data.products) {
                                await dbOperation(PRODUCTS_STORE, 'put', product);
                            }
                            products = data.products;
                            renderProducts();
                            renderProductsTable();
                        }
                        
                        if (data.sales) {
                            for (const sale of data.sales) {
                                await dbOperation(SALES_STORE, 'put', sale);
                            }
                            sales = data.sales;
                        }
                        
                        fileInput.value = '';
                        showAlert('Ë≥áÊñôÂåØÂÖ•ÊàêÂäüÔºÅ');
                        
                    } catch (error) {
                        console.error('ÂåØÂÖ•Â§±Êïó:', error);
                        showAlert('ÂåØÂÖ•Â§±ÊïóÔºåË´ãÊ™¢Êü•Ê™îÊ°àÊ†ºÂºè');
                    }
                };
                reader.readAsText(file);
            }

            async function init() {
                console.log('ÈñãÂßãÂàùÂßãÂåñ POS Á≥ªÁµ±...');
                await loadProducts();
                await loadSales();
                console.log('Â∑≤ËºâÂÖ•ÂïÜÂìÅÊï∏Èáè:', products.length);
                console.log('Â∑≤ËºâÂÖ•Èä∑ÂîÆË®òÈåÑ:', sales.length);
                console.log('POSÁ≥ªÁµ±ÂàùÂßãÂåñÂÆåÊàê ‚úì');
            }

            return {
                showPage,
                showAlert,
                closeAlert,
                addManualProduct,
                checkout,
                showProductModal,
                closeProductModal,
                saveProduct,
                editProduct,
                deleteProduct,
                updateQuantity,
                removeFromCart,
                exportData,
                importData,
                init
            };
        })();

        document.addEventListener('DOMContentLoaded', function() {
            APP.init();
        });

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', async function() {
                try {
                    const response = await fetch('./sw.js', { method: 'HEAD' }).catch(() => null);
                    if (response && response.ok) {
                        await navigator.serviceWorker.register('./sw.js');
                        console.log('Service WorkerË®ªÂÜäÊàêÂäü');
                    }
                } catch (error) {
                    console.log('Service Worker ‰∏çÂèØÁî®');
                }
            });
        }
    </script>
</body>
</html>
