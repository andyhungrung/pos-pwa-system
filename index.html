<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
    <meta name="theme-color" content="#2563eb" />
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="manifest" href="manifest.json" />
    <title>POSéŠ·å”®ç³»çµ±</title>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: #f3f4f6; }
        .container { height: 100vh; display: flex; flex-direction: column; }
        
        /* é ‚éƒ¨å°èˆª */
        .header { background: white; padding: 16px; border-bottom: 1px solid #e5e7eb; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .nav { display: flex; justify-content: space-between; align-items: center; }
        .title { font-size: 24px; font-weight: bold; color: #1f2937; }
        .nav-buttons { display: flex; gap: 8px; }
        .nav-btn { padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.2s; }
        .nav-btn.active { background: #2563eb; color: white; }
        .nav-btn:not(.active) { background: #e5e7eb; color: #374151; }
        .nav-btn:hover:not(.active) { background: #d1d5db; }
        
        /* ä¸»è¦å…§å®¹ */
        .main { flex: 1; overflow: hidden; }
        .page { display: none; height: 100%; }
        .page.active { display: flex; flex-direction: column; }
        
        /* å…±ç”¨æ¨£å¼ */
        .page-content { flex: 1; padding: 16px; overflow-y: auto; }
        .section-title { font-size: 20px; font-weight: 600; margin-bottom: 16px; }
        .card { background: white; padding: 16px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 16px; }
        .input { padding: 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; width: 100%; }
        .input:focus { outline: none; border-color: #3b82f6; }
        .button { padding: 12px 16px; background: #2563eb; color: white; border: none; border-radius: 6px; font-weight: 500; cursor: pointer; }
        .button:hover { background: #1d4ed8; }
        .button:disabled { opacity: 0.5; cursor: not-allowed; }
        .button-green { background: #16a34a; }
        .button-green:hover { background: #15803d; }
        .button-red { background: #dc2626; }
        .button-red:hover { background: #b91c1c; }
        .button-gray { background: #6b7280; }
        .button-gray:hover { background: #4b5563; }
        
        /* éŠ·å”®é é¢æ¨£å¼ */
        .sales-layout { flex: 1; display: flex; flex-direction: column; }
        @media (min-width: 769px) { .sales-layout { flex-direction: row; } }
        
        .products-area { flex: 2; padding: 16px; overflow-y: auto; }
        .cart-area { flex: 1; background: white; border-top: 2px solid #e5e7eb; padding: 16px; min-height: 200px; display: flex; flex-direction: column; }
        @media (min-width: 769px) { 
            .cart-area { width: 320px; border-top: none; border-left: 1px solid #e5e7eb; }
        }
        
        .manual-input { background: white; padding: 16px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 16px; }
        .input-group { display: flex; gap: 8px; flex-direction: column; }
        @media (min-width: 769px) { .input-group { flex-direction: row; } }
        
        .product-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
        @media (min-width: 769px) { .product-grid { grid-template-columns: repeat(3, 1fr); } }
        @media (min-width: 1024px) { .product-grid { grid-template-columns: repeat(4, 1fr); } }
        
        .product-card { background: white; padding: 16px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); cursor: pointer; text-align: center; min-height: 80px; display: flex; flex-direction: column; justify-content: center; border: 2px solid transparent; }
        .product-card:hover { border-color: #60a5fa; }
        
        .cart-items { flex: 1; overflow-y: auto; margin-bottom: 12px; }
        .cart-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #f3f4f6; }
        .cart-controls { display: flex; gap: 4px; align-items: center; }
        .control-btn { width: 28px; height: 28px; background: #e5e7eb; border: none; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 14px; }
        
        /* è¡¨æ ¼æ¨£å¼ */
        .table { width: 100%; border-collapse: collapse; }
        .table th, .table td { padding: 12px; text-align: left; border-bottom: 1px solid #e5e7eb; }
        .table th { background: #f9fafb; font-weight: 600; }
        
        /* æ¨¡æ…‹æ¡† */
        .modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; padding: 16px; }
        .modal-content { background: white; padding: 24px; border-radius: 8px; width: 100%; max-width: 400px; }
        .hidden { display: none; }
        
        /* çµ±è¨ˆå¡ç‰‡ */
        .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-bottom: 24px; }
        @media (min-width: 769px) { .stats-grid { grid-template-columns: repeat(4, 1fr); } }
        .stat-card { background: white; padding: 20px; border-radius: 8px; text-align: center; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .stat-number { font-size: 24px; font-weight: bold; color: #2563eb; }
        .stat-label { font-size: 12px; color: #6b7280; margin-top: 4px; }
    </style>
</head>
<body>
    <div id="app" class="container">
        <!-- é ‚éƒ¨å°èˆª -->
        <div class="header">
            <div class="nav">
                <h1 class="title">POSéŠ·å”®ç³»çµ±</h1>
                <div class="nav-buttons">
                    <button class="nav-btn active" onclick="showPage('sales')">éŠ·å”®</button>
                    <button class="nav-btn" onclick="showPage('products')">å•†å“</button>
                    <button class="nav-btn" onclick="showPage('reports')">å ±è¡¨</button>
                    <button class="nav-btn" onclick="showPage('backup')">å‚™ä»½</button>
                </div>
            </div>
        </div>

        <div class="main">
            <!-- éŠ·å”®é é¢ -->
            <div id="salesPage" class="page active">
                <div class="sales-layout">
                    <div class="products-area">
                        <h2 class="section-title">å•†å“é¸æ“‡</h2>
                        
                        <div class="manual-input">
                            <h3 style="font-weight: 500; margin-bottom: 12px;">å¿«é€Ÿæ–°å¢å•†å“</h3>
                            <div class="input-group">
                                <input id="productName" type="text" class="input" placeholder="å•†å“åç¨±" style="flex: 1;">
                                <input id="productPrice" type="number" class="input" placeholder="åƒ¹æ ¼" step="0.01" style="width: 120px;">
                                <button id="addManualBtn" class="button button-green">æ–°å¢</button>
                            </div>
                        </div>
                        
                        <div id="productGrid" class="product-grid"></div>
                    </div>

                    <div class="cart-area">
                        <h2 class="section-title">è³¼ç‰©è»Š</h2>
                        <div id="cartItems" class="cart-items">
                            <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: #6b7280;">
                                <div style="font-size: 32px; margin-bottom: 8px;">ğŸ›’</div>
                                <p>è³¼ç‰©è»Šæ˜¯ç©ºçš„</p>
                            </div>
                        </div>
                        <div style="padding-top: 12px; border-top: 1px solid #e5e7eb;">
                            <div id="totalAmount" style="font-size: 18px; font-weight: bold; margin-bottom: 12px;">ç¸½è¨ˆ: $0</div>
                            <button id="checkoutBtn" class="button" style="width: 100%;" disabled>çµå¸³</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å•†å“ç®¡ç†é é¢ -->
            <div id="productsPage" class="page">
                <div class="page-content">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                        <h2 class="section-title" style="margin: 0;">å•†å“ç®¡ç†</h2>
                        <button class="button button-green" onclick="showProductModal()">æ–°å¢å•†å“</button>
                    </div>
                    
                    <div class="card">
                        <table class="table" id="productsTable">
                            <thead>
                                <tr>
                                    <th>å•†å“åç¨±</th>
                                    <th>åƒ¹æ ¼</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="productsTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- å ±è¡¨é é¢ -->
            <div id="reportsPage" class="page">
                <div class="page-content">
                    <h2 class="section-title">éŠ·å”®å ±è¡¨</h2>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div id="totalProducts" class="stat-number">0</div>
                            <div class="stat-label">å•†å“ç¸½æ•¸</div>
                        </div>
                        <div class="stat-card">
                            <div id="totalSales" class="stat-number">0</div>
                            <div class="stat-label">éŠ·å”®ç­†æ•¸</div>
                        </div>
                        <div class="stat-card">
                            <div id="totalRevenue" class="stat-number">$0</div>
                            <div class="stat-label">ç¸½ç‡Ÿæ”¶</div>
                        </div>
                        <div class="stat-card">
                            <div id="avgOrder" class="stat-number">$0</div>
                            <div class="stat-label">å¹³å‡å®¢å–®åƒ¹</div>
                        </div>
                    </div>

                    <div class="card">
                        <h3 style="font-weight: 600; margin-bottom: 16px;">éŠ·å”®è¨˜éŒ„</h3>
                        <div id="salesHistory" style="max-height: 300px; overflow-y: auto;">
                            <p style="text-align: center; color: #6b7280; padding: 40px;">æš«ç„¡éŠ·å”®è¨˜éŒ„</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å‚™ä»½é é¢ -->
            <div id="backupPage" class="page">
                <div class="page-content">
                    <h2 class="section-title">è³‡æ–™å‚™ä»½èˆ‡é‚„åŸ</h2>
                    
                    <div style="display: grid; grid-template-columns: 1fr; gap: 16px;">
                        <div class="card">
                            <h3 style="font-weight: 600; margin-bottom: 12px;">å‚™ä»½è³‡æ–™</h3>
                            <p style="color: #6b7280; margin-bottom: 16px;">å°‡æ‰€æœ‰å•†å“å’ŒéŠ·å”®è³‡æ–™åŒ¯å‡ºç‚ºæª”æ¡ˆ</p>
                            <button class="button" onclick="exportData()">åŒ¯å‡ºè³‡æ–™</button>
                        </div>
                        
                        <div class="card">
                            <h3 style="font-weight: 600; margin-bottom: 12px;">é‚„åŸè³‡æ–™</h3>
                            <p style="color: #6b7280; margin-bottom: 16px;">å¾å‚™ä»½æª”æ¡ˆé‚„åŸè³‡æ–™</p>
                            <input type="file" id="importFile" accept=".json" style="margin-bottom: 12px;">
                            <button class="button button-gray" onclick="importData()">åŒ¯å…¥è³‡æ–™</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- å•†å“ç·¨è¼¯æ¨¡æ…‹æ¡† -->
    <div id="productModal" class="modal hidden">
        <div class="modal-content">
            <h3 id="modalTitle" style="font-size: 18px; font-weight: 600; margin-bottom: 16px;">æ–°å¢å•†å“</h3>
            <div style="margin-bottom: 16px;">
                <label style="display: block; margin-bottom: 4px; font-weight: 500;">å•†å“åç¨±</label>
                <input id="modalProductName" type="text" class="input">
            </div>
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 4px; font-weight: 500;">åƒ¹æ ¼</label>
                <input id="modalProductPrice" type="number" class="input" step="0.01">
            </div>
            <div style="display: flex; gap: 8px;">
                <button class="button" onclick="saveProduct()">å„²å­˜</button>
                <button class="button button-gray" onclick="closeProductModal()">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- æç¤ºå°è©±æ¡† -->
    <div id="alertModal" class="modal hidden">
        <div class="modal-content">
            <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 8px;">æç¤ºè¨Šæ¯</h3>
            <p id="alertMessage" style="color: #6b7280; margin-bottom: 16px;"></p>
            <button class="button" onclick="closeAlert()">ç¢ºå®š</button>
        </div>
    </div>

    <script>
        // å…¨åŸŸè®Šæ•¸
        let products = [];
        let cart = [];
        let cartTotal = 0;
        let sales = [];
        let editingProductId = null;

        // IndexedDB ç›¸é—œ
        const DB_NAME = 'POSSystemDB';
        const DB_VERSION = 2;
        const PRODUCTS_STORE = 'products';
        const SALES_STORE = 'sales';

        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onerror = () => reject(request.error);
                request.onsuccess = () => resolve(request.result);
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains(PRODUCTS_STORE)) {
                        db.createObjectStore(PRODUCTS_STORE, { keyPath: 'id' });
                    }
                    if (!db.objectStoreNames.contains(SALES_STORE)) {
                        db.createObjectStore(SALES_STORE, { keyPath: 'id' });
                    }
                };
            });
        }

        async function dbOperation(storeName, operation, data = null) {
            try {
                const db = await initDB();
                const transaction = db.transaction([storeName], operation === 'getAll' ? 'readonly' : 'readwrite');
                const store = transaction.objectStore(storeName);
                let request;
                
                switch (operation) {
                    case 'add': request = store.add(data); break;
                    case 'put': request = store.put(data); break;
                    case 'delete': request = store.delete(data); break;
                    case 'getAll': request = store.getAll(); break;
                }
                
                return new Promise((resolve, reject) => {
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            } catch (error) {
                console.error('DBæ“ä½œå¤±æ•—:', error);
                return null;
            }
        }

        // é é¢åˆ‡æ›
        function showPage(pageName) {
            // éš±è—æ‰€æœ‰é é¢
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            // æ›´æ–°å°èˆªæŒ‰éˆ•
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // é¡¯ç¤ºç›®æ¨™é é¢
            document.getElementById(pageName + 'Page').classList.add('active');
            event.target.classList.add('active');
            
            // è¼‰å…¥é é¢è³‡æ–™
            switch(pageName) {
                case 'products':
                    renderProductsTable();
                    break;
                case 'reports':
                    updateReports();
                    break;
            }
        }

        // æç¤ºåŠŸèƒ½
        function showAlert(message) {
            document.getElementById('alertMessage').textContent = message;
            document.getElementById('alertModal').classList.remove('hidden');
        }

        function closeAlert() {
            document.getElementById('alertModal').classList.add('hidden');
        }

        // è¼‰å…¥è³‡æ–™
        async function loadProducts() {
            const allProducts = await dbOperation(PRODUCTS_STORE, 'getAll');
            products = allProducts || [];
            renderProducts();
        }

        async function loadSales() {
            const allSales = await dbOperation(SALES_STORE, 'getAll');
            sales = allSales || [];
        }

        // æ¸²æŸ“å•†å“ç¶²æ ¼
        function renderProducts() {
            const grid = document.getElementById('productGrid');
            grid.innerHTML = '';
            
            products.forEach(product => {
                const card = document.createElement('div');
                card.className = 'product-card';
                card.innerHTML = `
                    <div style="font-weight: 500; margin-bottom: 4px;">${product.name}</div>
                    <div style="color: #2563eb; font-weight: bold;">$${product.price}</div>
                `;
                card.onclick = () => addToCart(product);
                grid.appendChild(card);
            });
        }

        // æ¸²æŸ“å•†å“ç®¡ç†è¡¨æ ¼
        function renderProductsTable() {
            const tbody = document.getElementById('productsTableBody');
            tbody.innerHTML = '';
            
            if (products.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; color: #6b7280; padding: 40px;">æš«ç„¡å•†å“è³‡æ–™</td></tr>';
                return;
            }
            
            products.forEach(product => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${product.name}</td>
                    <td>$${product.price}</td>
                    <td>
                        <button class="button" style="padding: 6px 12px; font-size: 12px; margin-right: 8px;" onclick="editProduct('${product.id}')">ç·¨è¼¯</button>
                        <button class="button button-red" style="padding: 6px 12px; font-size: 12px;" onclick="deleteProduct('${product.id}')">åˆªé™¤</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // è³¼ç‰©è»ŠåŠŸèƒ½
        function addToCart(product) {
            const existingItem = cart.find(item => item.id === product.id);
            if (existingItem) {
                existingItem.quantity += 1;
            } else {
                cart.push({ ...product, quantity: 1 });
            }
            updateCart();
        }

        function updateCart() {
            const cartItemsDiv = document.getElementById('cartItems');
            const totalDiv = document.getElementById('totalAmount');
            const checkoutBtn = document.getElementById('checkoutBtn');
            
            if (cart.length === 0) {
                cartItemsDiv.innerHTML = `
                    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: #6b7280;">
                        <div style="font-size: 32px; margin-bottom: 8px;">ğŸ›’</div>
                        <p>è³¼ç‰©è»Šæ˜¯ç©ºçš„</p>
                    </div>
                `;
                checkoutBtn.disabled = true;
                cartTotal = 0;
            } else {
                cartItemsDiv.innerHTML = '';
                cartTotal = 0;
                
                cart.forEach(item => {
                    cartTotal += item.price * item.quantity;
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'cart-item';
                    itemDiv.innerHTML = `
                        <div style="flex: 1;">
                            <div style="font-weight: 500; font-size: 14px;">${item.name}</div>
                            <div style="font-size: 12px; color: #6b7280;">$${item.price} Ã— ${item.quantity}</div>
                        </div>
                        <div class="cart-controls">
                            <button class="control-btn" onclick="updateQuantity('${item.id}', ${item.quantity - 1})">-</button>
                            <span style="width: 32px; text-align: center; font-size: 14px;">${item.quantity}</span>
                            <button class="control-btn" onclick="updateQuantity('${item.id}', ${item.quantity + 1})">+</button>
                            <button class="control-btn" onclick="removeFromCart('${item.id}')" style="background: #fef2f2; color: #dc2626;">Ã—</button>
                        </div>
                    `;
                    cartItemsDiv.appendChild(itemDiv);
                });
                checkoutBtn.disabled = false;
            }
            
            totalDiv.textContent = `ç¸½è¨ˆ: $${cartTotal}`;
        }

        function updateQuantity(productId, newQuantity) {
            if (newQuantity <= 0) {
                removeFromCart(productId);
            } else {
                const item = cart.find(item => item.id === productId);
                if (item) {
                    item.quantity = newQuantity;
                    updateCart();
                }
            }
        }

        function removeFromCart(productId) {
            cart = cart.filter(item => item.id !== productId);
            updateCart();
        }

        async function checkout() {
            if (cart.length === 0) return;
            
            const sale = {
                id: Date.now().toString(),
                items: [...cart],
                total: cartTotal,
                timestamp: new Date().toISOString()
            };
            
            await dbOperation(SALES_STORE, 'add', sale);
            sales.push(sale);
            
            showAlert(`çµå¸³æˆåŠŸï¼ç¸½é‡‘é¡ï¼š$${cartTotal}`);
            cart = [];
            updateCart();
        }

        // å•†å“ç®¡ç†
        function showProductModal(product = null) {
            editingProductId = product ? product.id : null;
            document.getElementById('modalTitle').textContent = product ? 'ç·¨è¼¯å•†å“' : 'æ–°å¢å•†å“';
            document.getElementById('modalProductName').value = product ? product.name : '';
            document.getElementById('modalProductPrice').value = product ? product.price : '';
            document.getElementById('productModal').classList.remove('hidden');
        }

        function closeProductModal() {
            document.getElementById('productModal').classList.add('hidden');
            editingProductId = null;
        }

        async function saveProduct() {
            const name = document.getElementById('modalProductName').value.trim();
            const price = parseFloat(document.getElementById('modalProductPrice').value);
            
            if (!name || !price) {
                showAlert('è«‹è¼¸å…¥å•†å“åç¨±å’Œåƒ¹æ ¼');
                return;
            }
            
            const product = {
                id: editingProductId || Date.now().toString(),
                name: name,
                price: price
            };
            
            await dbOperation(PRODUCTS_STORE, 'put', product);
            
            if (editingProductId) {
                const index = products.findIndex(p => p.id === editingProductId);
                if (index !== -1) {
                    products[index] = product;
                }
            } else {
                products.push(product);
            }
            
            renderProducts();
            renderProductsTable();
            closeProductModal();
            showAlert(editingProductId ? 'å•†å“æ›´æ–°æˆåŠŸ' : 'å•†å“æ–°å¢æˆåŠŸ');
        }

        function editProduct(id) {
            const product = products.find(p => p.id === id);
            if (product) {
                showProductModal(product);
            }
        }

        async function deleteProduct(id) {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤å•†å“å—ï¼Ÿ')) return;
            
            await dbOperation(PRODUCTS_STORE, 'delete', id);
            products = products.filter(p => p.id !== id);
            renderProducts();
            renderProductsTable();
            showAlert('å•†å“åˆªé™¤æˆåŠŸ');
        }

        // æ‰‹å‹•æ–°å¢å•†å“
        async function addManualProduct() {
            const name = document.getElementById('productName').value.trim();
            const price = parseFloat(document.getElementById('productPrice').value);
            
            if (!name || !price) {
                showAlert('è«‹è¼¸å…¥å•†å“åç¨±å’Œåƒ¹æ ¼');
                return;
            }
            
            const product = {
                id: Date.now().toString(),
                name: name,
                price: price
            };
            
            await dbOperation(PRODUCTS_STORE, 'put', product);
            products.push(product);
            addToCart(product);
            
            document.getElementById('productName').value = '';
            document.getElementById('productPrice').value = '';
            
            renderProducts();
        }

        // å ±è¡¨åŠŸèƒ½
        function updateReports() {
            const totalProductsEl = document.getElementById('totalProducts');
            const totalSalesEl = document.getElementById('totalSales');
            const totalRevenueEl = document.getElementById('totalRevenue');
            const avgOrderEl = document.getElementById('avgOrder');
            const salesHistoryEl = document.getElementById('salesHistory');
            
            totalProductsEl.textContent = products.length;
            totalSalesEl.textContent = sales.length;
            
            const revenue = sales.reduce((sum, sale) => sum + sale.total, 0);
            totalRevenueEl.textContent = `$${revenue}`;
            avgOrderEl.textContent = sales.length > 0 ? `$${Math.round(revenue / sales.length)}` : '$0';
            
            if (sales.length === 0) {
                salesHistoryEl.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 40px;">æš«ç„¡éŠ·å”®è¨˜éŒ„</p>';
            } else {
                salesHistoryEl.innerHTML = '';
                sales.slice(0, 10).forEach(sale => {
                    const saleDiv = document.createElement('div');
                    saleDiv.style.cssText = 'padding: 12px; border-bottom: 1px solid #f3f4f6;';
                    saleDiv.innerHTML = `
                        <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                            <span style="font-size: 12px; color: #6b7280;">${new Date(sale.timestamp).toLocaleString('zh-TW')}</span>
                            <span style="font-weight: 600;">$${sale.total}</span>
                        </div>
                        <div style="font-size: 12px; color: #6b7280;">
                            ${sale.items.map(item => `${item.name}Ã—${item.quantity}`).join(', ')}
                        </div>
                    `;
                    salesHistoryEl.appendChild(saleDiv);
                });
            }
        }

        // å‚™ä»½åŠŸèƒ½
        function exportData() {
            const data = {
                products: products,
                sales: sales,
                timestamp: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `POSå‚™ä»½_${new Date().toLocaleDateString('zh-TW').replace(/\//g, '-')}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
showAlert('è³‡æ–™åŒ¯å‡ºæˆåŠŸï¼');
        }

        function importData() {
            const fileInput = document.getElementById('importFile');
            const file = fileInput.files[0];
            
            if (!file) {
                showAlert('è«‹é¸æ“‡è¦åŒ¯å…¥çš„æª”æ¡ˆ');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (!confirm('åŒ¯å…¥è³‡æ–™å°‡è¦†è“‹ç¾æœ‰è³‡æ–™ï¼Œç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ')) return;
                    
                    // åŒ¯å…¥å•†å“
                    if (data.products) {
                        for (const product of data.products) {
                            await dbOperation(PRODUCTS_STORE, 'put', product);
                        }
                        products = data.products;
                        renderProducts();
                        renderProductsTable();
                    }
                    
                    // åŒ¯å…¥éŠ·å”®è¨˜éŒ„
                    if (data.sales) {
                        for (const sale of data.sales) {
                            await dbOperation(SALES_STORE, 'put', sale);
                        }
                        sales = data.sales;
                    }
                    
                    fileInput.value = '';
                    showAlert('è³‡æ–™åŒ¯å…¥æˆåŠŸï¼');
                    
                } catch (error) {
                    console.error('åŒ¯å…¥å¤±æ•—:', error);
                    showAlert('åŒ¯å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥æª”æ¡ˆæ ¼å¼');
                }
            };
            reader.readAsText(file);
        }

        // åˆå§‹åŒ–æ‡‰ç”¨
        document.addEventListener('DOMContentLoaded', async function() {
            // è¼‰å…¥è³‡æ–™
            await loadProducts();
            await loadSales();
            
            // ç¶å®šäº‹ä»¶
            document.getElementById('addManualBtn').onclick = addManualProduct;
            document.getElementById('checkoutBtn').onclick = checkout;
            
            console.log('POSç³»çµ±åˆå§‹åŒ–å®Œæˆ');
        });

        // Service Workerè¨»å†Š
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', async function() {
                try {
                    const registration = await navigator.serviceWorker.register('./sw.js');
                    console.log('Service Workerè¨»å†ŠæˆåŠŸ');
                } catch (error) {
                    console.error('Service Workerè¨»å†Šå¤±æ•—:', error);
                }
            });
        }
    </script>
</body>
</html>
